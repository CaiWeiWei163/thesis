<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="~{_viewStart}">
<meta charset="utf-8">
<th:block layout:fragment="styles">
    <link type="text/css" rel="stylesheet" th:href="@{/scripts/common/layui/layui_ext/dtree/dtree.css}"/>
    <link type="text/css" rel="stylesheet" th:href="@{/scripts/common/layui/layui_ext/dtree/dtree.css}"/>
    <link type="text/css" rel="stylesheet" th:href="@{/scripts/common/tag.css}"/>
    <!--多选下拉框CSS-->
    <link type="text/css" rel="stylesheet"
          th:href="@{/scripts/common/layui/layui_ext/formSelects/formSelects-v4.css}"/>
    <script type="text/javascript" th:src="@{/scripts/common/tag.js}"></script>
    <script src="../../scripts/common/ckeditor/ckeditor.js"></script>
</th:block>
<div layout:fragment="mainContent">
    <div class="layui-breadcrumb-box">
        <span class="layui-breadcrumb">
        <a><cite>论文管理/论文添加</cite></a>
        </span>
    </div>
    <div>
        <div class="layui-card" style="height: 750px">
            <div class="layui-card-body">
                <div class="layui-tab layui-tab-brief">
                    <div class="layui-tab-content">
                        <form class="layui-form" id="addThesisForm">
                            <div class="layui-form-item">
                                <label class="layui-form-label required">论文标题：</label>
                                <div class="layui-input-block">
                                    <input type="text" name="title" lay-verify="required" autocomplete="off"
                                           style="width: 1100px" placeholder="请输入论文标题" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">作者：</label>
                                <div class="layui-input-block">
                                    <div class="lay-ZD-search layui-form-select">
                                        <div class="layui-select-title">
                                            <input type="hidden" id="authorhidden">
                                            <input type="hidden" id="author" name="author" lay-verify="required">
                                        </div>
                                        <dl class="layui-anim layui-anim-upbit" id="pull_down_author">

                                        </dl>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">分类：</label>
                                <div class="layui-input-block">
                                    <div class="layui-select-title">
                                        <div class="lay-ZD-search layui-form-select">
                                            <div class="layui-select-title">
                                                <input type="hidden" id="typehidden">
                                                <input type="hidden" id="type" name="type" lay-verify="required">
                                            </div>
                                            <dl class="layui-anim layui-anim-upbit" id="pull_down_type">

                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">关键字：</label>
                                <div class="layui-input-block">
                                    <div class="layui-select-title">
                                        <div class="lay-ZD-search layui-form-select">
                                            <div class="layui-select-title">
                                                <input type="hidden" id="keywordhidden">
                                                <input type="hidden" id="keyword" name="keyword" lay-verify="required">
                                            </div>
                                            <dl class="layui-anim layui-anim-upbit" id="pull_down_keyword">

                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label required">引证文献：</label>
                                <div class="layui-input-block">
                                    <div class="layui-select-title">
                                        <div class="lay-ZD-search layui-form-select">
                                            <div class="layui-select-title">
                                                <input type="hidden" id="literaturehidden">
                                                <input type="hidden" id="literature" name="literature"
                                                       lay-verify="required">
                                            </div>
                                            <dl class="layui-anim layui-anim-upbit" id="pull_down_literature">

                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label required">摘要：</label>
                                <div class="layui-input-block">
                                    <textarea placeholder="请输入摘要" name="abstractContent" id="abstractContent"
                                              class="layui-textarea" lay-verify="required"
                                              style="width: 1100px">
                                    </textarea>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label required">论文内容：</label>
                                <div class="layui-input-block">
                                    <textarea placeholder="请输入论文内容" name="content" id="content" class="layui-textarea"
                                              style="width: 1100px">
                                    </textarea>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">论文原文件：</label>
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn" id="upload">
                                        <i class="layui-icon">&#xe67c;</i>选择文件
                                    </button>&nbsp;&nbsp;
                                    <strong><span id="filename" style="color: #009688;"></span></strong>
                                    <input type="hidden" name="fileinfoId" id="fileinfoId">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button type="button" class="layui-btn" lay-filter="save" id="save" lay-submit="">
                                        保 存
                                    </button>
                                    <button type="reset" class="layui-btn layui-btn-primary">重 置</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        $(function () {
            // 富文本编辑器:ckeditor
            var editor = CKEDITOR.replace('content', {width: '1100px', height: '300px'}, {
                toolbar:
                    [
                        //加粗     斜体，     下划线      穿过线      下标字        上标字
                        ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript'],
                        // 数字列表          实体列表            减小缩进    增大缩进
                        ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent'],
                        //左对 齐             居中对齐          右对齐          两端对齐
                        ['JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'],
                        //超链接  取消超链接 锚点
                        ['Link', 'Unlink', 'Anchor'],
                        //图片        表格       水平线            表情       特殊字符        分页符
                        ['Image', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar', 'PageBreak'],
                        '/',
                        // 样式       格式      字体    字体大小
                        ['Styles', 'Format', 'Font', 'FontSize'],
                        //文本颜色     背景颜色
                        ['TextColor', 'BGColor'],
                        //全屏           显示区块
                        ['Maximize', 'ShowBlocks', '-']
                    ]
            })

            layui.use(['form', 'layer', 'table', 'laytpl', 'element', 'formSelects', 'upload'], function () {
                var form = layui.form;
                var laytpl = layui.laytpl;
                var table = layui.table;
                var layer = layui.layer;
                var upload = layui.upload;

                //添加标签-作者
                var tagAuthor = new Tag("author");
                tagAuthor.initView();

                //添加标签-分类
                var tagType = new Tag("type");
                tagType.initView();

                //添加标签-关键字
                var tagKeyword = new Tag("keyword");
                tagKeyword.initView();

                //添加标签-引证文献
                var tagLiterature = new Tag("literature");
                tagLiterature.initView();

                // 模糊查询
                $("input").on("click", function () {
                    var idhidden = $(this).parent().prev().prev().attr("id");
                    console.log(idhidden);
                    if (idhidden == "authorhidden") {
                        setTimeout(function () {
                            getFuzzySearch(form, "author", "pull_down_author");
                            form.render();
                        }, 200);
                    }
                    if (idhidden == "typehidden") {
                        setTimeout(function () {
                            getFuzzySearch(form, "type", "pull_down_type");
                            form.render();
                        }, 200);
                    }
                    if (idhidden == "keywordhidden") {
                        setTimeout(function () {
                            getFuzzySearch(form, "keyword", "pull_down_keyword");
                            form.render();
                        }, 200);
                    }
                    if (idhidden == "literaturehidden") {
                        setTimeout(function () {
                            getFuzzySearch(form, "literature", "pull_down_literature");
                            form.render();
                        }, 200);
                    }
                });

                function getFuzzySearch(form, id, pulldown) {
                    $(".lay-ZD-search input").on("keyup", function () {
                        $("#" + pulldown).empty();
                        var str = "";
                        $(this).parents(".lay-ZD-search").addClass("layui-form-selected");
                        var search = $(this).val();
                        $.ajax({
                            url: TDFPath + 'thesisManage/ajax/fuzzySearch',
                            type: 'post',
                            data: {search: search, type: id},
                            success: function (res) {
                                $.each(res, function (i, item) {
                                    str += '<dd lay-value="' + item.dictvalue + '" class="">' + item.dictvalue + '</dd>'
                                })
                                $("#" + pulldown).append(str);
                                $("dd").on("click", function () {
                                    $("input[id='" + id + "']").next().children().val($(this).attr("lay-value"));
                                    $("#" + pulldown).hide();
                                });
                            },
                            error: function (error) {
                                layer.alert("获取数据失败")
                            }
                        });
                    }).on("click", function () {
                        $(this).trigger("keyup");
                    })
                }

                // 清除textarea内容
                $("#abstractContent").val("");
                $("#content").val("");

                // 文件上传
                upload.render({
                    type: 'post',
                    elem: '#upload'
                    , accept: 'file'
                    , url: TDFPath + 'thesisManage/uploadFile' // 上传接口
                    , done: function (res) {
                        //请求正常回调
                        if (res.code == 0) {
                            console.log(res);
                            $("#filename").html(res.data.fileName);
                            $("#fileinfoId").val(res.data.filePath);
                            layer.msg("上传成功！");
                        }
                    }
                    , error: function (res) {
                        //请求异常回调
                        layer.msg("上传失败，请稍后重试！");
                    }
                });

                // 保存
                form.on('submit(save)', function (data) {
                    var data = $("#addThesisForm").SerializeJson();
                    console.log("data:");
                    console.log(data);
                    sendAjax(layer, null, table, 'thesisManage/ajax/addThesis', 'POST', null, data, function (res) {
                        if (res.code == 0) {
                            location.href = TDFPath + "thesisManage/index";
                            layer.msg('添加论文成功！');
                        } else {
                            layer.msg(res.msg);
                        }
                    });
                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                });
            });
        });
    </script>
</th:block>
</html>
